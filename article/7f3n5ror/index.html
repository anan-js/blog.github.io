<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>多图片上传 | 知识小栈</title><meta name="description" content="个人博客anan"><link rel="preload" href="/blog.github.io/assets/style-DtZT97oa.css" as="style"><link rel="stylesheet" href="/blog.github.io/assets/style-DtZT97oa.css"><link rel="modulepreload" href="/blog.github.io/assets/app-DazCwyn3.js"><link rel="modulepreload" href="/blog.github.io/assets/index.html-CAAlp0Pb.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-f525dbff><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-a1004089></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-a1004089> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-f525dbff data-v-27878e05><div class="vp-navbar" vp-navbar data-v-27878e05 data-v-4afda74b><div class="wrapper" data-v-4afda74b><div class="container" data-v-4afda74b><div class="title" data-v-4afda74b><div class="vp-navbar-title" data-v-4afda74b data-v-8f1226f9><a class="vp-link no-icon link title" href="/blog.github.io/" data-v-8f1226f9 data-v-a45fcd4d><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-5f2196b6><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-5f2196b6><!--]--><!--]--><!--]--><span data-v-8f1226f9>知识小栈</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-4afda74b><div class="content-body" data-v-4afda74b><!--[--><!--]--><div class="vp-navbar-search search" data-v-4afda74b><div class="search-wrapper" data-v-5f167f7f><!----><div id="local-search" data-v-5f167f7f><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-5f167f7f><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-4afda74b data-v-db654a34><span id="main-nav-aria-label" class="visually-hidden" data-v-db654a34>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/categories/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>分类</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/tags/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/archives/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-db654a34 data-v-886bc60a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-886bc60a><span class="text" data-v-886bc60a><!----><!----><span data-v-886bc60a>笔记</span><span class="vpi-chevron-down text-icon" data-v-886bc60a></span></span></button><div class="menu" data-v-886bc60a><div class="vp-menu" data-v-886bc60a data-v-4cfe8990><div class="items" data-v-4cfe8990><!--[--><!--[--><div class="vp-menu-link" data-v-4cfe8990 data-v-16ef5475><a class="vp-link no-icon link" href="/blog.github.io/notes/demo/" data-v-16ef5475 data-v-a45fcd4d><!--[--><!----> 示例<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-4afda74b data-v-142e6c17><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-142e6c17 data-v-ff801465 data-v-f2492ef3><span class="check" data-v-f2492ef3><span class="icon" data-v-f2492ef3><!--[--><span class="vpi-sun sun" data-v-ff801465></span><span class="vpi-moon moon" data-v-ff801465></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-4afda74b data-v-a19c5bd6 data-v-6d4130dd><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-6d4130dd data-v-c5b94e79><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-4afda74b data-v-23df379f data-v-886bc60a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-886bc60a><span class="vpi-more-horizontal icon" data-v-886bc60a></span></button><div class="menu" data-v-886bc60a><div class="vp-menu" data-v-886bc60a data-v-4cfe8990><!----><!--[--><!--[--><!----><div class="group" data-v-23df379f><div class="item appearance" data-v-23df379f><p class="label" data-v-23df379f>外观</p><div class="appearance-action" data-v-23df379f><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-23df379f data-v-ff801465 data-v-f2492ef3><span class="check" data-v-f2492ef3><span class="icon" data-v-f2492ef3><!--[--><span class="vpi-sun sun" data-v-ff801465></span><span class="vpi-moon moon" data-v-ff801465></span><!--]--></span></span></button></div></div></div><div class="group" data-v-23df379f><div class="item social-links" data-v-23df379f><div class="vp-social-links social-links-list" data-v-23df379f data-v-6d4130dd><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-6d4130dd data-v-c5b94e79><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-4afda74b data-v-c5179613><span class="container" data-v-c5179613><span class="top" data-v-c5179613></span><span class="middle" data-v-c5179613></span><span class="bottom" data-v-c5179613></span></span></button></div></div></div></div><div class="divider" data-v-4afda74b><div class="divider-line" data-v-4afda74b></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-f525dbff data-v-0ff81230><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-0ff81230><span class="vpi-align-left menu-icon" data-v-0ff81230></span><span class="menu-text" data-v-0ff81230>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-0ff81230 data-v-d37b1a21><button data-v-d37b1a21>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-f525dbff data-v-b94ee560><div class="vp-doc-container is-blog" data-v-b94ee560 data-v-540f7185><!--[--><!--]--><div class="container" data-v-540f7185><!----><div class="content" data-v-540f7185><div class="content-container" data-v-540f7185><!--[--><!--]--><main class="main" data-v-540f7185><nav class="vp-breadcrumb" data-v-540f7185 data-v-20ecb185><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-20ecb185><!--[--><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="首页" data-v-20ecb185><meta property="position" content="1" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/blog/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="博客" data-v-20ecb185><meta property="position" content="2" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/blog/categories/?id=e3e2a9" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->docs<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="docs" data-v-20ecb185><meta property="position" content="3" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb current" href="/blog.github.io/article/7f3n5ror/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->多图片上传<!--]--><!----></a><!----><meta property="name" content="多图片上传" data-v-20ecb185><meta property="position" content="4" data-v-20ecb185></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-713fcf17>多图片上传 <!----></h1><div class="vp-doc-meta" data-v-713fcf17><p class="reading-time" data-v-713fcf17><span class="vpi-books icon" data-v-713fcf17></span><span data-v-713fcf17>约 4439 字</span><span data-v-713fcf17>大约 15 分钟</span></p><p data-v-713fcf17><span class="vpi-tag icon" data-v-713fcf17></span><!--[--><a class="vp-link no-icon link tag vp-tag-06i4" href="/blog.github.io/blog/tags/?tag=upload" data-v-713fcf17 data-v-a45fcd4d><!--[-->upload<!--]--><!----></a><a class="vp-link no-icon link tag vp-tag-tyeg" href="/blog.github.io/blog/tags/?tag=vue" data-v-713fcf17 data-v-a45fcd4d><!--[-->vue<!--]--><!----></a><!--]--></p><p class="create-time" data-v-713fcf17><span class="vpi-clock icon" data-v-713fcf17></span><span data-v-713fcf17>2024-03-02</span></p></div><!--]--><div class="_article_7f3n5ror_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-540f7185><div data-v-540f7185><ul><li><p><img src="/blog.github.io/assets/1729839140249-49143659-1ed5-427a-a319-859f904d493a-DwQfP1Lc.png" alt="img"></p><h3 id="使用场景" tabindex="-1"><a class="header-anchor" href="#使用场景"><span>使用场景</span></a></h3><h4 id="_1-电商平台" tabindex="-1"><a class="header-anchor" href="#_1-电商平台"><span>1. 电商平台</span></a></h4><ul><li>商家批量上传商品图片，如不同角度的商品展示图、规格图等。</li><li>在编辑商品时上传多张图片方便商品展示，提升用户体验。</li></ul><h4 id="_2-社交媒体和内容平台" tabindex="-1"><a class="header-anchor" href="#_2-社交媒体和内容平台"><span>2. 社交媒体和内容平台</span></a></h4><ul><li>用户上传多张照片、视频或文件分享个人动态或相册。</li><li>在图片分享和内容管理平台中，批量上传便于用户一次性上传多张图片，提升操作便捷性。</li></ul><h4 id="_3-内容管理系统-cms" tabindex="-1"><a class="header-anchor" href="#_3-内容管理系统-cms"><span>3. 内容管理系统（CMS）</span></a></h4><ul><li>站点管理者上传多媒体资源（图片、视频、文件等）以供网站使用。</li><li>批量上传可以帮助管理员高效地更新图片库和资源库。</li></ul><h4 id="_4-企业内部管理系统" tabindex="-1"><a class="header-anchor" href="#_4-企业内部管理系统"><span>4. 企业内部管理系统</span></a></h4><ul><li>批量上传员工证件照、身份证扫描件等，方便快速生成档案。</li><li>上传多个项目文件（如图纸、照片等）用于项目汇报、记录等需求。</li></ul><h4 id="_5-教育平台" tabindex="-1"><a class="header-anchor" href="#_5-教育平台"><span>5. 教育平台</span></a></h4><ul><li>教师上传多张课件图片、讲义或作业参考材料供学生参考。</li><li>学生上传多个作业文件，如笔记、照片、实验图片等。</li></ul><h4 id="_6-房地产、旅游等行业平台" tabindex="-1"><a class="header-anchor" href="#_6-房地产、旅游等行业平台"><span>6. 房地产、旅游等行业平台</span></a></h4><ul><li>房地产平台上传房源照片，如房间的各个角度、社区环境等。</li><li>旅游平台上传景点照片、活动照片等，展示更丰富的视觉内容。</li></ul><h3 id="难点和亮点" tabindex="-1"><a class="header-anchor" href="#难点和亮点"><span>难点和亮点</span></a></h3><p>批量上传的目的是提高用户上传大量文件的效率，并通过适当的并发控制避免对服务器造成负担</p><h4 id="_1-并发控制和性能优化" tabindex="-1"><a class="header-anchor" href="#_1-并发控制和性能优化"><span>1. 并发控制和性能优化</span></a></h4><ul><li><strong>并发限制</strong>：批量上传如果没有控制上传并发数量，容易引发请求暴增，导致服务器负载过高，可能造成服务器响应慢甚至宕机。</li><li><strong>文件大小限制</strong>：大图片文件的传输时间较长，会导致上传耗时过久，影响用户体验。需要对大文件进行压缩或分片处理。</li></ul><h4 id="_2-文件预处理" tabindex="-1"><a class="header-anchor" href="#_2-文件预处理"><span>2. 文件预处理</span></a></h4><ul><li><strong>图片压缩</strong>：在上传前对图片进行压缩，以减少上传时间和服务器存储空间。但压缩处理会占用前端资源，可能造成卡顿。</li><li><strong>格式转换</strong>：不同的图片格式可能需要在上传前进行转换（如将HEIC转换为JPEG），以提高兼容性，这通常需要使用Web Worker来避免阻塞UI线程。</li></ul><h4 id="_3-上传进度管理" tabindex="-1"><a class="header-anchor" href="#_3-上传进度管理"><span>3. 上传进度管理</span></a></h4><ul><li><strong>进度展示</strong>：用户体验中实时显示上传进度是非常重要的，特别是批量上传的场景。需要管理多个图片的进度，更新UI展示上传百分比或进度条。</li><li><strong>断点续传</strong>：如果上传中断（如网络不稳定或中途关闭页面），需支持断点续传，以确保用户不会因一次失败重新上传所有文件。</li></ul><h4 id="_4-错误处理与重试机制" tabindex="-1"><a class="header-anchor" href="#_4-错误处理与重试机制"><span>4. 错误处理与重试机制</span></a></h4><ul><li><strong>失败重试</strong>：上传过程中可能遇到网络波动、请求失败、文件格式不符合等问题。批量上传需要提供合理的重试机制或失败提示，让用户选择是否重新上传。</li><li><strong>错误回调</strong>：批量上传涉及多个文件时，每个文件可能会遇到不同的上传错误，需要有精细的错误回调来区分错误类型并进行相应处理。</li></ul><h3 id="具体的代码" tabindex="-1"><a class="header-anchor" href="#具体的代码"><span>具体的代码</span></a></h3><p><strong>第一点优化</strong></p><ul><li><strong>并发限制</strong>：控制同时上传的图片数量，避免服务器压力过大。</li><li><strong>文件大小限制</strong>：在上传前检查文件大小，超出限制则阻止上传。</li></ul><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;template&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-upload</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ref=&quot;uploadRef&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:http-request=&quot;customHttpRequest&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:on-change=&quot;handleFileChange&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:before-upload=&quot;beforeUpload&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:file-list=&quot;fileList&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multiple</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:limit=&quot;10&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:auto-upload=&quot;false&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;&gt;批量上传图片&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/el-upload&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;</span><span class="space"> </span><span>@click=&quot;startUpload&quot;&gt;开始上传&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span>&lt;/template&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;script</span><span class="space"> </span><span>setup&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ref</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;vue&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ElButton,</span><span class="space"> </span><span>ElUpload,</span><span class="space"> </span><span>ElMessage</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;element-plus&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileList</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>maxConcurrentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>最大并发上传数量</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>maxSizeInMB</span><span class="space"> </span><span>=</span><span class="space"> </span><span>2;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>文件大小限制，单位：MB</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>uploadQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>[];</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>handleFileChange</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file,</span><span class="space"> </span><span>files)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>将文件加入到队列中</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uploadQueue.push(file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>文件大小限制检查</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>beforeUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>isUnderLimit</span><span class="space"> </span><span>=</span><span class="space"> </span><span>file.size</span><span class="space"> </span><span>/</span><span class="space"> </span><span>1024</span><span class="space"> </span><span>/</span><span class="space"> </span><span>1024</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxSizeInMB;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(!isUnderLimit)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ElMessage.error(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>超出大小限制（最大</span><span class="space"> </span><span>${maxSizeInMB}</span><span class="space"> </span><span>MB）`);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>return</span><span class="space"> </span><span>isUnderLimit;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>控制并发上传，限制同时上传数量</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>customHttpRequest</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(options)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentUploads</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>return;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>{</span><span class="space"> </span><span>file,</span><span class="space"> </span><span>onProgress,</span><span class="space"> </span><span>onSuccess,</span><span class="space"> </span><span>onError</span><span class="space"> </span><span>}</span><span class="space"> </span><span>=</span><span class="space"> </span><span>options;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>创建XMLHttpRequest并配置上传进度</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>xhr</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>XMLHttpRequest();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.open(&#39;POST&#39;,</span><span class="space"> </span><span>options.action,</span><span class="space"> </span><span>true);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.upload.onprogress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(event.lengthComputable)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event.loaded</span><span class="space"> </span><span>/</span><span class="space"> </span><span>event.total)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress({</span><span class="space"> </span><span>percent:</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess(xhr.response);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onerror</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError(xhr.response);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>formData</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>FormData();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;file&#39;,</span><span class="space"> </span><span>file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.send(formData);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>处理队列，限制同时上传数量</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>processQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>while</span><span class="space"> </span><span>(uploadQueue.length</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>file</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadQueue.shift();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.error(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传失败`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>开始上传</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>startUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span>&lt;/script&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>文件大小检查</strong>：<code>beforeUpload</code>函数会在文件加入队列前判断文件大小是否超过<code>maxSizeInMB</code>限制，如果超出则阻止上传，并给出提示信息。</li><li><strong>并发上传限制</strong>：</li><li>定义了<code>maxConcurrentUploads</code>限制同时上传的文件数量。</li><li><code>uploadQueue</code>用于保存待上传的文件队列，<code>currentUploads</code>记录当前上传中的文件数量。</li><li><code>customHttpRequest</code>是自定义的上传请求，在每次上传完毕后递减<code>currentUploads</code>，并调用<code>processQueue</code>继续处理队列中的文件。</li><li><code>processQueue</code>函数会检查<code>uploadQueue</code>并发起新的上传请求，确保不会超过并发上传限制。</li></ul><p><strong>第二点优化</strong></p><p>使用<code>Web Worker</code>对图片文件在上传前进行<strong>压缩</strong>和<strong>格式转换</strong>。通过<code>Web Worker</code>来处理这些耗时操作，避免主线程阻塞，提升用户体验。</p><p>创建一个<code>Web Worker</code>文件 <code>imageWorker.js</code>，用于处理图片的压缩和格式转换操作。使用<code>Canvas</code> API实现图片压缩，并将图片格式转换为<code>JPEG</code>或<code>PNG</code>等常见格式。</p><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>//</span><span class="space"> </span><span>imageWorker.js</span></span>
<span class="line"><span>self.onmessage</span><span class="space"> </span><span>=</span><span class="space"> </span><span>async</span><span class="space"> </span><span>function</span><span class="space"> </span><span>(e)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>{</span><span class="space"> </span><span>file,</span><span class="space"> </span><span>quality,</span><span class="space"> </span><span>targetFormat</span><span class="space"> </span><span>}</span><span class="space"> </span><span>=</span><span class="space"> </span><span>e.data;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>compressImage</span><span class="space"> </span><span>=</span><span class="space"> </span><span>async</span><span class="space"> </span><span>(file,</span><span class="space"> </span><span>quality,</span><span class="space"> </span><span>format)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>return</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Promise((resolve)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>img</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Image();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>img.src</span><span class="space"> </span><span>=</span><span class="space"> </span><span>URL.createObjectURL(file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>img.onload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>canvas</span><span class="space"> </span><span>=</span><span class="space"> </span><span>document.createElement(&#39;canvas&#39;);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>canvas.width</span><span class="space"> </span><span>=</span><span class="space"> </span><span>img.width;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>canvas.height</span><span class="space"> </span><span>=</span><span class="space"> </span><span>img.height;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>ctx</span><span class="space"> </span><span>=</span><span class="space"> </span><span>canvas.getContext(&#39;2d&#39;);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ctx.drawImage(img,</span><span class="space"> </span><span>0,</span><span class="space"> </span><span>0,</span><span class="space"> </span><span>img.width,</span><span class="space"> </span><span>img.height);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>设置格式和质量，转换图片</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>canvas.toBlob(</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>(blob)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>compressedFile</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>File([blob],</span><span class="space"> </span><span>file.name,</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>type:</span><span class="space"> </span><span>`image/${format}`,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>lastModified:</span><span class="space"> </span><span>Date.now(),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>resolve(compressedFile);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>},</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>`image/${format}`,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quality</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>调用压缩方法</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>processedFile</span><span class="space"> </span><span>=</span><span class="space"> </span><span>await</span><span class="space"> </span><span>compressImage(file,</span><span class="space"> </span><span>quality,</span><span class="space"> </span><span>targetFormat);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>self.postMessage(processedFile);</span></span>
<span class="line"><span>};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Vue 组件中使用 Web Worker 进行图片预处理</p><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;template&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-upload</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ref=&quot;uploadRef&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:http-request=&quot;customHttpRequest&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:on-change=&quot;handleFileChange&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:before-upload=&quot;beforeUpload&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:file-list=&quot;fileList&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multiple</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:limit=&quot;10&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:auto-upload=&quot;false&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;&gt;批量上传图片&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/el-upload&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;</span><span class="space"> </span><span>@click=&quot;startUpload&quot;&gt;开始上传&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span>&lt;/template&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;script</span><span class="space"> </span><span>setup&gt;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ref,</span><span class="space"> </span><span>onMounted,</span><span class="space"> </span><span>onUnmounted</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;vue&#39;;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ElMessage</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;element-plus&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>fileList</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>maxConcurrentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>最大并发上传数</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>uploadQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>[];</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>worker;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>handleFileChange</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file,</span><span class="space"> </span><span>files)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadQueue.push(file);</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>初始化</span><span class="space"> </span><span>Web</span><span class="space"> </span><span>Worker</span></span>
<span class="line"><span>onMounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>worker</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Worker(new</span><span class="space"> </span><span>URL(&#39;./imageWorker.js&#39;,</span><span class="space"> </span><span>import.meta.url));</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>onUnmounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(worker)</span><span class="space"> </span><span>worker.terminate();</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>图片预处理，压缩和格式转换</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>beforeUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>return</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Promise((resolve)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.postMessage({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quality:</span><span class="space"> </span><span>0.7,</span><span class="space"> </span><span>//</span><span class="space"> </span><span>图片压缩质量，0到1之间</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>targetFormat:</span><span class="space"> </span><span>&#39;jpeg&#39;,</span><span class="space"> </span><span>//</span><span class="space"> </span><span>目标格式，可以是</span><span class="space"> </span><span>&#39;jpeg&#39;</span><span class="space"> </span><span>或</span><span class="space"> </span><span>&#39;png&#39;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>监听</span><span class="space"> </span><span>Web</span><span class="space"> </span><span>Worker</span><span class="space"> </span><span>返回的压缩文件</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.onmessage</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(e)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>processedFile</span><span class="space"> </span><span>=</span><span class="space"> </span><span>e.data;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>resolve(processedFile);</span><span class="space"> </span><span>//</span><span class="space"> </span><span>返回压缩后的文件</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>自定义上传请求，限制并发数量</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>customHttpRequest</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(options)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentUploads</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>return;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>currentUploads++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>{</span><span class="space"> </span><span>file,</span><span class="space"> </span><span>onProgress,</span><span class="space"> </span><span>onSuccess,</span><span class="space"> </span><span>onError</span><span class="space"> </span><span>}</span><span class="space"> </span><span>=</span><span class="space"> </span><span>options;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>xhr</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>XMLHttpRequest();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>xhr.open(&#39;POST&#39;,</span><span class="space"> </span><span>options.action,</span><span class="space"> </span><span>true);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>xhr.upload.onprogress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(event.lengthComputable)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event.loaded</span><span class="space"> </span><span>/</span><span class="space"> </span><span>event.total)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress({</span><span class="space"> </span><span>percent:</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>xhr.onload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess(xhr.response);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>xhr.onerror</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError(xhr.response);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>formData</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>FormData();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;file&#39;,</span><span class="space"> </span><span>file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>xhr.send(formData);</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>处理队列，限制同时上传数量</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>processQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>while</span><span class="space"> </span><span>(uploadQueue.length</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>file</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadQueue.shift();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.error(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传失败`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>开始上传</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>startUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span>&lt;/script&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>Web Worker压缩和格式转换</strong>：<code>imageWorker.js</code>文件中，使用<code>Canvas</code> API压缩图片并转换格式，通过<code>postMessage</code>返回处理后的文件。</li><li><code>compressImage</code>函数将图片绘制到<code>Canvas</code>上，并将其转换为指定的格式和质量。</li><li><strong>Vue组件中使用 Web Worker</strong>：</li><li>在<code>beforeUpload</code>钩子中，图片会传入<code>Web Worker</code>进行预处理（压缩和格式转换）。</li><li><code>worker.onmessage</code>监听预处理完成后的文件，并将其加入到上传队列。</li><li><strong>自定义上传和并发控制</strong>：通过<code>customHttpRequest</code>和<code>processQueue</code>方法，控制同时上传的数量，确保不会超出<code>maxConcurrentUploads</code>的限制。</li></ul><p><strong>第三点优化</strong></p><p>实现<strong>上传进度管理的UI展示</strong>、<strong>断点续传</strong>和<strong>多文件进度管理</strong>，我们可以做以下几项优化：</p><ol><li><strong>上传进度展示</strong>**：为每张图片添加进度条，实时显示上传进度。**</li><li><strong>断点续传</strong>**：对已上传的数据做断点标记，当上传中断时可以从中断的部分继续上传。**</li><li><strong>多文件进度管理</strong>**：管理每个文件的上传进度状态，并在UI上展示。**</li></ol><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;template&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-upload</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ref=&quot;uploadRef&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:http-request=&quot;customHttpRequest&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:on-change=&quot;handleFileChange&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:before-upload=&quot;beforeUpload&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:file-list=&quot;fileList&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multiple</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:auto-upload=&quot;false&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;&gt;批量上传图片&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/el-upload&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;</span><span class="space"> </span><span>@click=&quot;startUpload&quot;&gt;开始上传&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div</span><span class="space"> </span><span>v-for=&quot;(file,</span><span class="space"> </span><span>index)</span><span class="space"> </span><span>in</span><span class="space"> </span><span>uploadStatus&quot;</span><span class="space"> </span><span>:key=&quot;file.uid&quot;</span><span class="space"> </span><span>class=&quot;upload-item&quot;&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span&gt;{{ file.name }}&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-progress</span><span class="space"> </span><span>:percentage=&quot;file.progress&quot;</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;uploading&#39;&quot;</span><span class="space"> </span><span>/&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;completed&#39;&quot;&gt;上传完成&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;failed&#39;&quot;&gt;上传失败&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span>&lt;/template&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;script</span><span class="space"> </span><span>setup&gt;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ref,</span><span class="space"> </span><span>onMounted,</span><span class="space"> </span><span>onUnmounted</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;vue&#39;;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ElMessage</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;element-plus&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>fileList</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>uploadStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>maxConcurrentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>最大并发上传数</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>uploadQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>[];</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>worker;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>handleFileChange</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadQueue.push(file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadStatus.value.push({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uid:</span><span class="space"> </span><span>file.uid,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name:</span><span class="space"> </span><span>file.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>progress:</span><span class="space"> </span><span>0,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status:</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>文件预处理，压缩和格式转换</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>beforeUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>return</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Promise((resolve)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.postMessage({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quality:</span><span class="space"> </span><span>0.7,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>targetFormat:</span><span class="space"> </span><span>&#39;jpeg&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.onmessage</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(e)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>processedFile</span><span class="space"> </span><span>=</span><span class="space"> </span><span>e.data;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>resolve(processedFile);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>自定义上传请求，限制并发数量，支持断点续传</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>customHttpRequest</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(options)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentUploads</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>return;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>currentUploads++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>{</span><span class="space"> </span><span>file,</span><span class="space"> </span><span>onProgress,</span><span class="space"> </span><span>onSuccess,</span><span class="space"> </span><span>onError</span><span class="space"> </span><span>}</span><span class="space"> </span><span>=</span><span class="space"> </span><span>options;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>storedProgress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>localStorage.getItem(`upload-progress-${file.uid}`)</span><span class="space"> </span><span>||</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>=</span><span class="space"> </span><span>parseInt(storedProgress,</span><span class="space"> </span><span>10);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>上传进度更新</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>updateProgress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>((uploadedBytes</span><span class="space"> </span><span>+</span><span class="space"> </span><span>event.loaded)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>file.size)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>progress;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress({</span><span class="space"> </span><span>percent:</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>localStorage.setItem(`upload-progress-${file.uid}`,</span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>+</span><span class="space"> </span><span>event.loaded);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>自定义分块上传实现断点续传</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>chunkSize</span><span class="space"> </span><span>=</span><span class="space"> </span><span>1024</span><span class="space"> </span><span>*</span><span class="space"> </span><span>1024;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>1MB的分块大小</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>totalChunks</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.ceil(file.size</span><span class="space"> </span><span>/</span><span class="space"> </span><span>chunkSize);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>currentChunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.floor(uploadedBytes</span><span class="space"> </span><span>/</span><span class="space"> </span><span>chunkSize);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>uploadChunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentChunk</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>totalChunks)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>localStorage.removeItem(`upload-progress-${file.uid}`);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;completed&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>return;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>start</span><span class="space"> </span><span>=</span><span class="space"> </span><span>currentChunk</span><span class="space"> </span><span>*</span><span class="space"> </span><span>chunkSize;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>end</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.min(start</span><span class="space"> </span><span>+</span><span class="space"> </span><span>chunkSize,</span><span class="space"> </span><span>file.size);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>chunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>file.slice(start,</span><span class="space"> </span><span>end);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>formData</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>FormData();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;file&#39;,</span><span class="space"> </span><span>chunk);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;filename&#39;,</span><span class="space"> </span><span>file.name);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;chunkNumber&#39;,</span><span class="space"> </span><span>currentChunk);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;totalChunks&#39;,</span><span class="space"> </span><span>totalChunks);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>xhr</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>XMLHttpRequest();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.open(&#39;POST&#39;,</span><span class="space"> </span><span>options.action,</span><span class="space"> </span><span>true);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.upload.onprogress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>updateProgress;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>+=</span><span class="space"> </span><span>chunk.size;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentChunk++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uploadChunk();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onerror</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;failed&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.send(formData);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadChunk();</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>处理队列，限制同时上传数量</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>processQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>while</span><span class="space"> </span><span>(uploadQueue.length</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>file</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadQueue.shift();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;uploading&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.error(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传失败`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>开始上传</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>startUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>初始化</span><span class="space"> </span><span>Web</span><span class="space"> </span><span>Worker</span></span>
<span class="line"><span>onMounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>worker</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Worker(new</span><span class="space"> </span><span>URL(&#39;./imageWorker.js&#39;,</span><span class="space"> </span><span>import.meta.url));</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>onUnmounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(worker)</span><span class="space"> </span><span>worker.terminate();</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span>&lt;/script&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;style&gt;</span></span>
<span class="line"><span>.upload-item</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>display:</span><span class="space"> </span><span>flex;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>align-items:</span><span class="space"> </span><span>center;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>margin-top:</span><span class="space"> </span><span>10px;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>&lt;/style&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>断点续传</strong>：我们将每个文件按1MB大小分块上传。<code>localStorage</code>中记录上传进度，当网络中断或页面关闭后，可以从最后一次成功上传的分块继续。</li><li><code>customHttpRequest</code>方法根据存储的进度决定从哪个分块开始上传。</li><li>每完成一块上传，更新<code>uploadedBytes</code>并保存到<code>localStorage</code>中，以便下次继续上传。</li><li><strong>上传进度管理</strong>：</li><li><code>uploadStatus</code>数组用于跟踪每个文件的上传状态和进度。</li><li>每次分块上传进度通过<code>onProgress</code>事件更新。</li><li>通过<code>el-progress</code>展示每个文件的上传进度，更新UI。</li><li><strong>错误处理</strong>：</li><li>如果某个分块上传失败，标记为<code>failed</code>并展示在UI中，用户可以选择手动重试。</li></ul><p><strong>第4点优化</strong></p><ul><li><strong>错误提示</strong>**：为每个文件记录错误信息并展示在UI上。**</li><li><strong>错误分类和重试</strong>**：实现精细化的错误回调，通过**<code>**retryCount**</code><strong>控制每个文件的重试次数。如果超过最大重试次数，则提供手动重试选项。</strong></li><li><strong>重试按钮</strong>**：在上传失败的文件上显示“重试”按钮，让用户在手动点击时可以重新上传该文件。**</li></ul><div class="language-vue line-numbers-mode" data-ext="vue" data-title="vue"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>&lt;template&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-upload</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ref=&quot;uploadRef&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:http-request=&quot;customHttpRequest&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:on-change=&quot;handleFileChange&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:before-upload=&quot;beforeUpload&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:file-list=&quot;fileList&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>multiple</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>:auto-upload=&quot;false&quot;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;&gt;批量上传图片&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/el-upload&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;primary&quot;</span><span class="space"> </span><span>@click=&quot;startUpload&quot;&gt;开始上传&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;div</span><span class="space"> </span><span>v-for=&quot;(file,</span><span class="space"> </span><span>index)</span><span class="space"> </span><span>in</span><span class="space"> </span><span>uploadStatus&quot;</span><span class="space"> </span><span>:key=&quot;file.uid&quot;</span><span class="space"> </span><span>class=&quot;upload-item&quot;&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span&gt;{{ file.name }}&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-progress</span><span class="space"> </span><span>:percentage=&quot;file.progress&quot;</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;uploading&#39;&quot;</span><span class="space"> </span><span>/&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;completed&#39;&quot;&gt;上传完成&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;span</span><span class="space"> </span><span>v-if=&quot;file.status</span><span class="space"> </span><span>===</span><span class="space"> </span><span>&#39;failed&#39;&quot;</span><span class="space"> </span><span>class=&quot;error-message&quot;&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>上传失败：{{ file.error }}&amp;nbsp;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;el-button</span><span class="space"> </span><span>type=&quot;text&quot;</span><span class="space"> </span><span>@click=&quot;retryUpload(file)&quot;&gt;重试&lt;/el-button&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/span&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>&lt;/div&gt;</span></span>
<span class="line"><span>&lt;/template&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;script</span><span class="space"> </span><span>setup&gt;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ref,</span><span class="space"> </span><span>onMounted,</span><span class="space"> </span><span>onUnmounted</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;vue&#39;;</span></span>
<span class="line"><span>import</span><span class="space"> </span><span>{</span><span class="space"> </span><span>ElMessage</span><span class="space"> </span><span>}</span><span class="space"> </span><span>from</span><span class="space"> </span><span>&#39;element-plus&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>fileList</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>uploadStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>ref([]);</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>maxConcurrentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3;</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>maxRetries</span><span class="space"> </span><span>=</span><span class="space"> </span><span>3;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>最大重试次数</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>uploadQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>[];</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span>let</span><span class="space"> </span><span>worker;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>handleFileChange</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadQueue.push(file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadStatus.value.push({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uid:</span><span class="space"> </span><span>file.uid,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>name:</span><span class="space"> </span><span>file.name,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>progress:</span><span class="space"> </span><span>0,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>status:</span><span class="space"> </span><span>&#39;pending&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>error:</span><span class="space"> </span><span>null,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>retryCount:</span><span class="space"> </span><span>0,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>const</span><span class="space"> </span><span>beforeUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>return</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Promise((resolve)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.postMessage({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>quality:</span><span class="space"> </span><span>0.7,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>targetFormat:</span><span class="space"> </span><span>&#39;jpeg&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>worker.onmessage</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(e)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>processedFile</span><span class="space"> </span><span>=</span><span class="space"> </span><span>e.data;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>resolve(processedFile);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>自定义上传请求，限制并发数量，支持断点续传和错误处理</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>customHttpRequest</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(options)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentUploads</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>return;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>currentUploads++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>{</span><span class="space"> </span><span>file,</span><span class="space"> </span><span>onProgress,</span><span class="space"> </span><span>onSuccess,</span><span class="space"> </span><span>onError</span><span class="space"> </span><span>}</span><span class="space"> </span><span>=</span><span class="space"> </span><span>options;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>storedProgress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>localStorage.getItem(`upload-progress-${file.uid}`)</span><span class="space"> </span><span>||</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>=</span><span class="space"> </span><span>parseInt(storedProgress,</span><span class="space"> </span><span>10);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>上传进度更新</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>updateProgress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>((uploadedBytes</span><span class="space"> </span><span>+</span><span class="space"> </span><span>event.loaded)</span><span class="space"> </span><span>/</span><span class="space"> </span><span>file.size)</span><span class="space"> </span><span>*</span><span class="space"> </span><span>100;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.progress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>progress;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress({</span><span class="space"> </span><span>percent:</span><span class="space"> </span><span>progress</span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>localStorage.setItem(`upload-progress-${file.uid}`,</span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>+</span><span class="space"> </span><span>event.loaded);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>//</span><span class="space"> </span><span>自定义分块上传实现断点续传</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>chunkSize</span><span class="space"> </span><span>=</span><span class="space"> </span><span>1024</span><span class="space"> </span><span>*</span><span class="space"> </span><span>1024;</span><span class="space"> </span><span>//</span><span class="space"> </span><span>1MB的分块大小</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>totalChunks</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.ceil(file.size</span><span class="space"> </span><span>/</span><span class="space"> </span><span>chunkSize);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>let</span><span class="space"> </span><span>currentChunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.floor(uploadedBytes</span><span class="space"> </span><span>/</span><span class="space"> </span><span>chunkSize);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>uploadChunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(currentChunk</span><span class="space"> </span><span>&gt;=</span><span class="space"> </span><span>totalChunks)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>localStorage.removeItem(`upload-progress-${file.uid}`);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentUploads--;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;completed&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fileStatus.error</span><span class="space"> </span><span>=</span><span class="space"> </span><span>null;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>return;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>start</span><span class="space"> </span><span>=</span><span class="space"> </span><span>currentChunk</span><span class="space"> </span><span>*</span><span class="space"> </span><span>chunkSize;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>end</span><span class="space"> </span><span>=</span><span class="space"> </span><span>Math.min(start</span><span class="space"> </span><span>+</span><span class="space"> </span><span>chunkSize,</span><span class="space"> </span><span>file.size);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>chunk</span><span class="space"> </span><span>=</span><span class="space"> </span><span>file.slice(start,</span><span class="space"> </span><span>end);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>formData</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>FormData();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;file&#39;,</span><span class="space"> </span><span>chunk);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;filename&#39;,</span><span class="space"> </span><span>file.name);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;chunkNumber&#39;,</span><span class="space"> </span><span>currentChunk);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>formData.append(&#39;totalChunks&#39;,</span><span class="space"> </span><span>totalChunks);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>xhr</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>XMLHttpRequest();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.open(&#39;POST&#39;,</span><span class="space"> </span><span>options.action,</span><span class="space"> </span><span>true);</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.upload.onprogress</span><span class="space"> </span><span>=</span><span class="space"> </span><span>updateProgress;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uploadedBytes</span><span class="space"> </span><span>+=</span><span class="space"> </span><span>chunk.size;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>currentChunk++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>uploadChunk();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.onerror</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>handleUploadError(file);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>xhr.send(formData);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>uploadChunk();</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>处理上传错误，重试或记录错误</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>handleUploadError</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus.retryCount</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxRetries)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fileStatus.retryCount++;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ElMessage.warning(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传失败，重试第</span><span class="space"> </span><span>${fileStatus.retryCount}</span><span class="space"> </span><span>次`);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>handleUploadError(file),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>}</span><span class="space"> </span><span>else</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;failed&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>fileStatus.error</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;网络错误或服务器问题，上传失败&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>ElMessage.error(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传失败，请检查网络或稍后重试`);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>重试上传</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>retryUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>(file)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>fileStatus.retryCount</span><span class="space"> </span><span>=</span><span class="space"> </span><span>0;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;uploading&#39;;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>fileStatus.error</span><span class="space"> </span><span>=</span><span class="space"> </span><span>null;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>handleUploadError(file),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>处理队列，限制同时上传数量</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>processQueue</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>while</span><span class="space"> </span><span>(uploadQueue.length</span><span class="space"> </span><span>&gt;</span><span class="space"> </span><span>0</span><span class="space"> </span><span>&amp;&amp;</span><span class="space"> </span><span>currentUploads</span><span class="space"> </span><span>&lt;</span><span class="space"> </span><span>maxConcurrentUploads)</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>file</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadQueue.shift();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>const</span><span class="space"> </span><span>fileStatus</span><span class="space"> </span><span>=</span><span class="space"> </span><span>uploadStatus.value.find((item)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>item.uid</span><span class="space"> </span><span>===</span><span class="space"> </span><span>file.uid);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(fileStatus)</span><span class="space"> </span><span>fileStatus.status</span><span class="space"> </span><span>=</span><span class="space"> </span><span>&#39;uploading&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>customHttpRequest({</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>action:</span><span class="space"> </span><span>&#39;https://your-upload-endpoint&#39;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>file,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onProgress:</span><span class="space"> </span><span>(event)</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>console.log(&#39;progress:&#39;,</span><span class="space"> </span><span>event.percent),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onSuccess:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>ElMessage.success(`文件</span><span class="space"> </span><span>${file.name}</span><span class="space"> </span><span>上传成功`),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>onError:</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>handleUploadError(file),</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>});</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>}</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>开始上传</span></span>
<span class="line"><span>const</span><span class="space"> </span><span>startUpload</span><span class="space"> </span><span>=</span><span class="space"> </span><span>()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>processQueue();</span></span>
<span class="line"><span>};</span></span>
<span class="line"><span></span></span>
<span class="line"><span>//</span><span class="space"> </span><span>初始化</span><span class="space"> </span><span>Web</span><span class="space"> </span><span>Worker</span></span>
<span class="line"><span>onMounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>worker</span><span class="space"> </span><span>=</span><span class="space"> </span><span>new</span><span class="space"> </span><span>Worker(new</span><span class="space"> </span><span>URL(&#39;./imageWorker.js&#39;,</span><span class="space"> </span><span>import.meta.url));</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span></span></span>
<span class="line"><span>onUnmounted(()</span><span class="space"> </span><span>=&gt;</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>if</span><span class="space"> </span><span>(worker)</span><span class="space"> </span><span>worker.terminate();</span></span>
<span class="line"><span>});</span></span>
<span class="line"><span>&lt;/script&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>&lt;style&gt;</span></span>
<span class="line"><span>.upload-item</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>display:</span><span class="space"> </span><span>flex;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>align-items:</span><span class="space"> </span><span>center;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>margin-top:</span><span class="space"> </span><span>10px;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>.error-message</span><span class="space"> </span><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>color:</span><span class="space"> </span><span>red;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span>font-weight:</span><span class="space"> </span><span>bold;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>&lt;/style&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong>错误处理和重试逻辑</strong>：</li></ol><ul><li><ul><li><code>handleUploadError</code> 方法对上传失败的文件进行错误处理。若<code>retryCount</code>小于<code>maxRetries</code>，则自动重试。</li><li>超过最大重试次数时，将文件状态更新为<code>failed</code>并记录错误信息。</li></ul></li></ul><ol><li><strong>重试按钮</strong>：</li></ol><ul><li><ul><li>在文件状态为<code>failed</code>时，显示“重试”按钮，用户可手动点击重新上传。</li><li><code>retryUpload</code> 方法重置重试次数，并重新调用<code>customHttpRequest</code>来重新上传失败文件。</li></ul></li></ul><ol><li><strong>上传进度和状态管理</strong>：</li></ol><ul><li><ul><li>每个文件的状态在<code>uploadStatus</code>中管理，状态包括<code>pending</code>、<code>uploading</code>、<code>completed</code>和<code>failed</code>，UI根据状态更新显示。</li></ul></li></ul><ol><li><strong>精细的错误信息展示</strong>：</li></ol><ul><li><ul><li>每个文件错误类型独立记录并展示在UI中，避免因多个文件错误导致混淆。</li></ul></li></ul><p>这样可以更好地支持批量上传过程中各个文件的精细管理、进度监控以及错误处理。</p><h3 id="node后端接口服务" tabindex="-1"><a class="header-anchor" href="#node后端接口服务"><span>node后端接口服务</span></a></h3><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-file-upload-demo</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-file-upload-demo</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">npm</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">init</span><span class="space"> </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">-y</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pnpm</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">install</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-router</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-body</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs-extra</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在项目文件夹中创建 <code>app.js</code> 文件并添加以下代码。</p><div class="language-javascript line-numbers-mode" data-ext="javascript" data-title="javascript"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">app.js</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Koa</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">require</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">Router</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">require</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-router</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">koaBody</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">require</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">koa-body</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">require</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">fs-extra</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">require</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">path</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">app</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">new</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Koa</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">router</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">new</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Router</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">resolve</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">__dirname</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">uploads</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">上传文件存储目录</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ensureDirSync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">确保上传目录存在</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">合并分块文件</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">async</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">function</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mergeChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filename</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">totalChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filename</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">_chunks</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ensureFile</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">确保目标文件存在</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">writeStream</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">createWriteStream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">for</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">let</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">&lt;</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">totalChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">i</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">++</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkPath</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-chunk-</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">i</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">readFile</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">writeStream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">write</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">remove</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">清理分块文件</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">writeStream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">end</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">();</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">rmdir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">删除分块文件夹</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">文件上传接口</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">router</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">post</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/upload</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">koaBody</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">({</span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">multipart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">true</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}),</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">async</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=&gt;</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkNumber</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">totalChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filename</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">file</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">request</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">files</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">_chunks</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ensureDir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">确保分块目录存在</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">将文件分块存储在指定目录下</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkPath</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkDir</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">-chunk-</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">chunkNumber</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">move</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">file</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">当所有分块上传完毕后进行合并</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">if</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">parseInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">chunkNumber</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">+</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">===</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">parseInt</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">totalChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">await</span><span class="space"> </span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mergeChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filename</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">totalChunks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">File</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">upload</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">complete</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">url</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/uploads/</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">else</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Chunk</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">chunkNumber</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">uploaded</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">//</span><span class="space"> </span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">静态文件服务</span></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">router</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">get</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/uploads/:filename</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">async</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=&gt;</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">UPLOAD_DIR</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">params</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filename</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">if</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">existsSync</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">))</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">set</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Content-Disposition</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">attachment;</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename=</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">${</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">params</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">filename</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">`</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">fs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">createReadStream</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">filePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">else</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">status</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">404</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">ctx</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">body</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span><span class="space"> </span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">message</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span class="space"> </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">File</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">not</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">found</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">};</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">use</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">router</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">routes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()).</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">use</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">router</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">allowedMethods</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">());</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">listen</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">3000</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=&gt;</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">console</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">log</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Server</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">running</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">on</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">http://localhost:3000</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">});</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong>合并分块</strong>：</li></ol><ul><li><ul><li><code>mergeChunks</code> 方法将所有上传的分块按照顺序合并成完整的文件。</li><li>合并后删除临时的分块文件和分块目录。</li></ul></li></ul><ol><li><strong>文件上传</strong>：</li></ol><ul><li><ul><li><code>/upload</code> 路由接收文件分块上传请求，处理 <code>chunkNumber</code> 和 <code>totalChunks</code> 信息。</li><li>每个分块被存储在一个临时文件夹中，命名格式为 <code>${filename}_chunks</code>。</li><li>每上传一个分块后，后端会返回上传的分块编号。如果检测到当前分块是最后一个分块，后端将调用 <code>mergeChunks</code> 方法进行文件合并。</li></ul></li></ul><ol><li><strong>静态文件服务</strong>：</li></ol><ul><li><ul><li><code>/uploads/:filename</code> 路由用于访问上传后的文件，可用于测试文件是否上传成功。</li></ul></li></ul><p>在终端中运行以下命令启动服务器：</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">node</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">app.js</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>服务器启动后，访问 <code>http://localhost:3000</code>，</p><p>前端代码中的上传接口地址设置为 <code>http://localhost:3000/upload</code>。</p></li></ul></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-540f7185 data-v-e737c5a5><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-e737c5a5><span class="contributors-label" data-v-e737c5a5>贡献者: </span><span class="contributors-info" data-v-e737c5a5><!--[--><!--[--><span class="contributor" data-v-e737c5a5>hello-xiaowu</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-e737c5a5><div class="pager" data-v-e737c5a5><a class="vp-link no-icon link pager-link prev" href="/blog.github.io/article/n3pipeop/" data-v-e737c5a5 data-v-a45fcd4d><!--[--><span class="desc" data-v-e737c5a5>上一页</span><span class="title" data-v-e737c5a5>webpack配置</span><!--]--><!----></a></div><div class="pager" data-v-e737c5a5><a class="vp-link no-icon link pager-link next" href="/blog.github.io/article/8zh2ad76/" data-v-e737c5a5 data-v-a45fcd4d><!--[--><span class="desc" data-v-e737c5a5>下一页</span><span class="title" data-v-e737c5a5>nginx</span><!--]--><!----></a></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-f525dbff data-v-8910cbcb><span class="percent" data-allow-mismatch data-v-8910cbcb>0%</span><span class="show icon vpi-back-to-top" data-v-8910cbcb></span><svg aria-hidden="true" data-v-8910cbcb><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-8910cbcb></circle></svg></button><footer class="vp-footer" vp-footer data-v-f525dbff data-v-35b9c334><!--[--><div class="container" data-v-35b9c334><p class="message" data-v-35b9c334>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/blog.github.io/assets/app-DazCwyn3.js" defer></script></body></html>
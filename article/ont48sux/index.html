<!doctype html><html lang="zh-CN"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="generator" content="VuePress 2.0.0-rc.20" /><meta name="theme" content="VuePress Theme Plume " /><script id="check-mac-os">document.documentElement.classList.toggle('mac', /Mac|iPhone|iPod|iPad/i.test(navigator.platform))</script><script id="check-dark-mode">;(function () {const um= localStorage.getItem('vuepress-theme-appearance') || 'auto';const sm = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;const isDark = um === 'dark' || (um !== 'light' && sm);document.documentElement.dataset.theme = isDark ? 'dark' : 'light';})();</script><link rel="icon" type="image/png" href="https://theme-plume.vuejs.press/favicon-32x32.png"><title>调试 Vue 源码 | 知识小栈</title><meta name="description" content="个人博客anan"><link rel="preload" href="/blog.github.io/assets/style-DtZT97oa.css" as="style"><link rel="stylesheet" href="/blog.github.io/assets/style-DtZT97oa.css"><link rel="modulepreload" href="/blog.github.io/assets/app-DazCwyn3.js"><link rel="modulepreload" href="/blog.github.io/assets/index.html-C4D-7rae.js"></head><body><div id="app"><!--[--><!--[--><div class="theme-plume vp-layout" vp-container data-v-f525dbff><!--[--><!--[--><!--]--><!--[--><span tabindex="-1" data-v-a1004089></span><a href="#VPContent" class="vp-skip-link visually-hidden" data-v-a1004089> Skip to content </a><!--]--><!----><header class="vp-nav" data-v-f525dbff data-v-27878e05><div class="vp-navbar" vp-navbar data-v-27878e05 data-v-4afda74b><div class="wrapper" data-v-4afda74b><div class="container" data-v-4afda74b><div class="title" data-v-4afda74b><div class="vp-navbar-title" data-v-4afda74b data-v-8f1226f9><a class="vp-link no-icon link title" href="/blog.github.io/" data-v-8f1226f9 data-v-a45fcd4d><!--[--><!--[--><!--]--><!--[--><!--[--><!--[--><img class="vp-image dark logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-5f2196b6><!--]--><!--[--><img class="vp-image light logo" style="" src="https://theme-plume.vuejs.press/plume.png" alt data-v-5f2196b6><!--]--><!--]--><!--]--><span data-v-8f1226f9>知识小栈</span><!--[--><!--]--><!--]--><!----></a></div></div><div class="content" data-v-4afda74b><div class="content-body" data-v-4afda74b><!--[--><!--]--><div class="vp-navbar-search search" data-v-4afda74b><div class="search-wrapper" data-v-5f167f7f><!----><div id="local-search" data-v-5f167f7f><button type="button" class="mini-search mini-search-button" aria-label="搜索文档" data-v-5f167f7f><span class="mini-search-button-container"><span class="mini-search-search-icon vpi-mini-search" aria-label="search icon"></span><span class="mini-search-button-placeholder">搜索文档</span></span><span class="mini-search-button-keys"><kbd class="mini-search-button-key"></kbd><kbd class="mini-search-button-key">K</kbd></span></button></div></div></div><nav aria-labelledby="main-nav-aria-label" class="vp-navbar-menu menu" data-v-4afda74b data-v-db654a34><span id="main-nav-aria-label" class="visually-hidden" data-v-db654a34>Main Navigation</span><!--[--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>首页</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>博客</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/categories/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>分类</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/tags/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>标签</span><!--]--><!----></a><!--]--><!--[--><a class="vp-link no-icon link navbar-menu-link" href="/blog.github.io/blog/archives/" tabindex="0" data-v-db654a34 data-v-fe07ebe4 data-v-a45fcd4d><!--[--><!----><span data-v-fe07ebe4>归档</span><!--]--><!----></a><!--]--><!--[--><div class="vp-flyout vp-navbar-menu-group" data-v-db654a34 data-v-886bc60a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-886bc60a><span class="text" data-v-886bc60a><!----><!----><span data-v-886bc60a>笔记</span><span class="vpi-chevron-down text-icon" data-v-886bc60a></span></span></button><div class="menu" data-v-886bc60a><div class="vp-menu" data-v-886bc60a data-v-4cfe8990><div class="items" data-v-4cfe8990><!--[--><!--[--><div class="vp-menu-link" data-v-4cfe8990 data-v-16ef5475><a class="vp-link no-icon link" href="/blog.github.io/notes/demo/" data-v-16ef5475 data-v-a45fcd4d><!--[--><!----> 示例<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><!----><div class="vp-navbar-appearance appearance" data-v-4afda74b data-v-142e6c17><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-142e6c17 data-v-ff801465 data-v-f2492ef3><span class="check" data-v-f2492ef3><span class="icon" data-v-f2492ef3><!--[--><span class="vpi-sun sun" data-v-ff801465></span><span class="vpi-moon moon" data-v-ff801465></span><!--]--></span></span></button></div><div class="vp-social-links vp-navbar-social-links social-links" data-v-4afda74b data-v-a19c5bd6 data-v-6d4130dd><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-6d4130dd data-v-c5b94e79><span class="vpi-social-github" /></a><!--]--></div><div class="vp-flyout vp-navbar-extra extra" data-v-4afda74b data-v-23df379f data-v-886bc60a><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-886bc60a><span class="vpi-more-horizontal icon" data-v-886bc60a></span></button><div class="menu" data-v-886bc60a><div class="vp-menu" data-v-886bc60a data-v-4cfe8990><!----><!--[--><!--[--><!----><div class="group" data-v-23df379f><div class="item appearance" data-v-23df379f><p class="label" data-v-23df379f>外观</p><div class="appearance-action" data-v-23df379f><button class="vp-switch vp-switch-appearance" type="button" role="switch" title aria-checked="false" data-v-23df379f data-v-ff801465 data-v-f2492ef3><span class="check" data-v-f2492ef3><span class="icon" data-v-f2492ef3><!--[--><span class="vpi-sun sun" data-v-ff801465></span><span class="vpi-moon moon" data-v-ff801465></span><!--]--></span></span></button></div></div></div><div class="group" data-v-23df379f><div class="item social-links" data-v-23df379f><div class="vp-social-links social-links-list" data-v-23df379f data-v-6d4130dd><!--[--><a class="vp-social-link no-icon" href="/" aria-label="github" target="_blank" rel="noopener" data-v-6d4130dd data-v-c5b94e79><span class="vpi-social-github" /></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="vp-navbar-hamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="nav-screen" data-v-4afda74b data-v-c5179613><span class="container" data-v-c5179613><span class="top" data-v-c5179613></span><span class="middle" data-v-c5179613></span><span class="bottom" data-v-c5179613></span></span></button></div></div></div></div><div class="divider" data-v-4afda74b><div class="divider-line" data-v-4afda74b></div></div></div><!----></header><div class="vp-local-nav fixed reached-top is-blog" data-v-f525dbff data-v-0ff81230><button class="hidden menu" disabled aria-expanded="false" aria-controls="SidebarNav" data-v-0ff81230><span class="vpi-align-left menu-icon" data-v-0ff81230></span><span class="menu-text" data-v-0ff81230>Menu</span></button><div class="vp-local-nav-outline-dropdown" style="--vp-vh:0px;" data-v-0ff81230 data-v-d37b1a21><button data-v-d37b1a21>返回顶部</button><!----></div></div><!----><!--[--><div id="VPContent" vp-content class="vp-content" data-v-f525dbff data-v-b94ee560><div class="vp-doc-container is-blog" data-v-b94ee560 data-v-540f7185><!--[--><!--]--><div class="container" data-v-540f7185><!----><div class="content" data-v-540f7185><div class="content-container" data-v-540f7185><!--[--><!--]--><main class="main" data-v-540f7185><nav class="vp-breadcrumb" data-v-540f7185 data-v-20ecb185><ol vocab="https://schema.org/" typeof="BreadcrumbList" data-v-20ecb185><!--[--><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->首页<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="首页" data-v-20ecb185><meta property="position" content="1" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/blog/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->博客<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="博客" data-v-20ecb185><meta property="position" content="2" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb" href="/blog.github.io/blog/categories/?id=e3e2a9" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->docs<!--]--><!----></a><span class="vpi-chevron-right" data-v-20ecb185></span><meta property="name" content="docs" data-v-20ecb185><meta property="position" content="3" data-v-20ecb185></li><li property="itemListElement" typeof="ListItem" data-v-20ecb185><a class="vp-link no-icon link breadcrumb current" href="/blog.github.io/article/ont48sux/" property="item" typeof="WebPage" data-v-20ecb185 data-v-a45fcd4d><!--[-->调试 Vue 源码<!--]--><!----></a><!----><meta property="name" content="调试 Vue 源码" data-v-20ecb185><meta property="position" content="4" data-v-20ecb185></li><!--]--></ol></nav><!--[--><h1 class="vp-doc-title page-title" data-v-713fcf17>调试 Vue 源码 <!----></h1><div class="vp-doc-meta" data-v-713fcf17><p class="reading-time" data-v-713fcf17><span class="vpi-books icon" data-v-713fcf17></span><span data-v-713fcf17>约 1555 字</span><span data-v-713fcf17>大约 5 分钟</span></p><p data-v-713fcf17><span class="vpi-tag icon" data-v-713fcf17></span><!--[--><a class="vp-link no-icon link tag vp-tag-tyeg" href="/blog.github.io/blog/tags/?tag=vue" data-v-713fcf17 data-v-a45fcd4d><!--[-->vue<!--]--><!----></a><a class="vp-link no-icon link tag vp-tag-ilsx" href="/blog.github.io/blog/tags/?tag=源码" data-v-713fcf17 data-v-a45fcd4d><!--[-->源码<!--]--><!----></a><a class="vp-link no-icon link tag vp-tag-yyjl" href="/blog.github.io/blog/tags/?tag=Debugger" data-v-713fcf17 data-v-a45fcd4d><!--[-->Debugger<!--]--><!----></a><!--]--></p><p class="create-time" data-v-713fcf17><span class="vpi-clock icon" data-v-713fcf17></span><span data-v-713fcf17>2022-03-01</span></p></div><!--]--><div class="_article_ont48sux_ external-link-icon-enabled vp-doc plume-content" vp-content data-v-540f7185><div data-v-540f7185><p>知道了如何调试 React 源码，这节我们再来调试下 Vue 源码。</p><p>首先，还是通过 vue cli 创建项目（要用 5.0 以上的 cli）：</p><p>安装 @vue/cli 后执行 vue create vue-demo 创建 vue 项目：</p><div class="language-lua line-numbers-mode" data-ext="lua" data-title="lua"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vue</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">create</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">vue</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">-</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">demo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/blog.github.io/assets/8b62a31fc5f64a569264aba7d78815b0~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-Day1UWht.jpg" alt="img"></p><p>选择 vue3 的模版。</p><p>安装完之后进入到 vue-demo 目录，执行 npm run serve 把开发服务跑起来。</p><p><img src="/blog.github.io/assets/205e0401f35244a487daeb625faed8bb~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-Da3Wd0AN.jpg" alt="img"></p><p>浏览器访问，会看到渲染出的页面：</p><p><img src="/blog.github.io/assets/beef0fa2220347918b8cdf133365a723~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-BtiyOWLL.jpg" alt="img"></p><p>修改下 vue.config.js，把 devtool 改成 source-map：</p><p><img src="/blog.github.io/assets/a79387d593b24010a870d8e8f68f3c8d~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-CNMF4GGE.jpg" alt="img"></p><p>然后我们进行调试：</p><p>点击调试窗口的 create a launch.json file 来创建调试配置文件：</p><p><img src="/blog.github.io/assets/189a01024a7141e28edf126ffecc8959~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-B8zEV4Jh.jpg" alt="img"></p><p>修改调试配置如下：</p><div class="language-json line-numbers-mode" data-ext="json" data-title="json"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;type&quot;:</span><span class="space"> </span><span>&quot;chrome&quot;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;request&quot;:</span><span class="space"> </span><span>&quot;launch&quot;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;name&quot;:</span><span class="space"> </span><span>&quot;调试</span><span class="space"> </span><span>Vue</span><span class="space"> </span><span>项目&quot;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;runtimeExecutable&quot;:</span><span class="space"> </span><span>&quot;canary&quot;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;runtimeArgs&quot;:</span><span class="space"> </span><span>[</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;--auto-open-devtools-for-tabs&quot;,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>],</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;userDataDir&quot;:</span><span class="space"> </span><span>false,</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span>&quot;url&quot;:</span><span class="space"> </span><span>&quot;http://localhost:8081&quot;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就可以在 VSCode 里打断点调试了。</p><p>但是这样调试 Vue 源码的话还不够，你会发现调用栈里的路径是 node_modules 下的 runtime-core.esm-bundler.js：</p><p><img src="/blog.github.io/assets/9f76b37902734b0482e744d6d7e31646~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DT5TJhtj.jpg" alt="img"></p><p>这明显是经过编译打包之后的，而我们想要调试的是 Vue 最初的源码。</p><p>这就需要用到 sourcemap 了。</p><p>从 npm 下载的 vue 包是不带 sourcemap 的，我们需要把源码下载下来自己 build。</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">clone</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">https://github.com/vuejs/core</span><span class="space"> </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vue3</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>下载 vue3 的代码，用 pnpm install 安装依赖（这是 vue3 指定的依赖管理工具）。</p><p>执行 pnpm run build，就会在每个包下产生 dist 目录：</p><p><img src="/blog.github.io/assets/ec8586ab2d3b47638c63db3e0caa59c0~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DD6_bRa4.jpg" alt="img"></p><p>这时候的产物肯定是不带 sourcemap 的。</p><p>那难道也要像调试 React 源码那样改造 build 脚本么？</p><p>这个倒不用，vue3 源码里贴心的为需要生成 sourcemap 的情况做了支持。</p><p><img src="/blog.github.io/assets/a7cd17e423644e7590f6234f4ec0bfd2~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-BVM8MNp0.jpg" alt="img"></p><p>只要配置下这个环境变量就行。</p><p>执行 export SOURCE_MAP=true 然后再跑 pnpm run build：</p><p><img src="/blog.github.io/assets/35e838e7716b432e88b96eae0114e629~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-D9VI6sGd.jpg" alt="img"></p><p>build 完成后，再去看包下的 dist 产物，你就会发现有 sourcemap 了：</p><p><img src="/blog.github.io/assets/015c9ab52b834b9b9060aad194dd54c8~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DMRFDsif.jpg" alt="img"></p><p>相比 react 源码生成 sourcemap 简单了很多。</p><p>把 runtime-core 包下的 dist 复制出来，覆盖 vue-demo 项目的 node_modules 下的 dist 目录：</p><p><img src="/blog.github.io/assets/7c2232ef340a404fb5906dcee0efe8dc~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DLpZK-OK.jpg" alt="img"></p><p>重新跑 npm run serve，并且重新 debug：</p><p><img src="/blog.github.io/assets/0223714d16c04071b612f74988df21d5~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-BE7A1Brh.jpg" alt="img"></p><p>这时候你会发现调试的就是源码了，很明显是 src 下的 ts 文件。</p><p>对比下之前的：</p><p><img src="/blog.github.io/assets/9f76b37902734b0482e744d6d7e31646~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DT5TJhtj.jpg" alt="img"></p><p>是不是瞬间就懂了为什么要用 sourcemap 了？</p><p>当然，这里把 sourcemap 应用到项目里也没有 create-react-app 里那么费劲，明显是 vue-cli 对 node_modules 下的 sourcemap 做了支持，简单了很多。</p><p>只不过现在 sourcemap 到的路径不大对，没有 runtime-core 的包名，不能编辑：</p><p><img src="/blog.github.io/assets/19170508445a4911a0f3194c10022b9a~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-C_3Qboi_.jpg" alt="img"></p><p>这种情况有两种处理方式，一种是配置下 sourceMapPathOverrides，把这段路径再做一次映射，映射到源码目录就可以了。</p><p>另一种方式就是改造下 vue3 的 build 脚本，让生成的 sourcemap 就直接是正确的路径。</p><p>我们采用第二种方式。</p><p>再次打开 vue3 源码目录，找到 rollup.config.js 里 sourcemap 配置的地方，添加一段配置:</p><p><img src="/blog.github.io/assets/a352ce90ecb64826b7a0aba016bba07f~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-DnhVdGIF.jpg" alt="img"></p><div class="language-javascript line-numbers-mode" data-ext="javascript" data-title="javascript"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">output</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sourcemapPathTransform</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">relativeSourcePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sourcemapPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=&gt;</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">{</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">const</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newSourcePath</span><span class="space"> </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">join</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">path</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dirname</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">sourcemapPath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">),</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">relativeSourcePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">);</span></span>
<span class="line"><span class="space"> </span><span class="space"> </span><span class="space"> </span><span class="space"> </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">return</span><span class="space"> </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">newSourcePath</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里的两个参数，sourcemapPath 就是 sourcemap 的绝对路径，比如这样 /Users/guang/code/vue3/packages/runtime-core/dist/runtime-core.cjs.js.map，而 relativeSourcePath 是 sourcemap 的路径到源码路径的相对路径，比如这样 ../src/errorHandling.ts</p><p>那要计算出源码的绝对路径，就可以先取 sourcemapPath 的目录路径，然后再根据相对路径查找到源码文件，这样就是源码的绝对路径了。</p><p>加了这个配置之后，重新 build 一下：</p><p><img src="/blog.github.io/assets/a7cd093e758e483f9f99b7ae1452ef77~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-B9YmT9wl.jpg" alt="img"></p><p>这时候生成的 sourcemap 里的源码路径就是绝对路径。</p><p>用新的 dist 目录覆盖 vue-demo 的 node_modules 下的 @vue/runtime-core 的 dist 目录，然后重新 npm run serve：</p><p>这时候调用栈中的 vue 代码就是源码的绝对路径了，能找到文件，自然也就不再是只读：</p><p><img src="/blog.github.io/assets/42e1fc45249740649f62cd9edfa64c65~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-BLz8Z4Tp.jpg" alt="img"></p><p>如果你重新跑 npm run serve，那可能是有 babel loader 的缓存：</p><p><img src="/blog.github.io/assets/ff20f2a5f0ad4118b53373b7f793742d~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-B8Z7p8ED.jpg" alt="img"></p><p>手动 rm -rf ./node_modules/.cache/babel-loader 就可以了。</p><p>当然，更好的体验还是像调试 React 代码那样，把 vue 源码和 vue-demo 项目放到同一个 workspace 下：</p><p><img src="/blog.github.io/assets/002487e244b442fdbbbb6a9b3ccd3852~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-CkNGmYoJ.jpg" alt="img"></p><p>这里因为移动了 vue3 源码的位置，那 sourcemap 到的路径变了，所以还要进入 vue3 源码路径重新 build 依次，再把 sourcemap 复制到 vue-demo 目录的 node_modules 下。</p><p>再次调试，点击调用栈中的源码，就能直接在 workspace 里打开：</p><p><img src="/blog.github.io/assets/1eb7c86fa08c44218e74ae5888d0550d~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-xM4kkcgG.jpg" alt="img"></p><p>之后就能愉快的调试 vue 源码了。</p><p>对比下之前的调用栈：</p><p><img src="/blog.github.io/assets/062d62a3e0f349838b90216ce2f2f66a~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-Y03KDrNK.jpg" alt="img"></p><p>再看下现在的调用栈：</p><p><img src="/blog.github.io/assets/fe46a5edb4e3428db1b65d2c4a8bc280~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-B4pbelXY.jpg" alt="img"></p><p>点击就可以打开源码目录下的对应文件。</p><p>你平时开发的项目也可以这样把 node_modules 下 的 @vue/runtime-core 的 dist 目录替换掉，这样调试项目之余，还可以看看源码。把 vue 也加到 workspace 那一步倒不是必须的。</p><p>有的同学用 vite 调试 vue3 源码，也可以，但要把 vue 的预加载禁用，不然路径就变了：</p><p><img src="/blog.github.io/assets/367f0f4017e24ad99752df40327fe1b2~tplv-k3u1fbpfcp-jj-mark_1512_0_0_0_q75-BTZnio4w.jpg" alt="img"></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>这节我们调试了下 vue 源码，它同样也需要 sourcemap，我们下载了 vue 源码，然后 build 出了带有 sourcemap 的代码，覆盖 demo 项目的 node_modules 下的包，之后再次调试就可以直接调试源码了。</p><p>但是这时候 sourcemap 到的路径不对，所以源码文件是只读的。我们修改了 build 配置，通过 output.sourcemapPathTransform 修改了 sourcemap 到的源码地址，再次调试就能找到源码的绝对路径，这样内容就是可修改的了。</p><p>如果想点击调用栈直接在 workspace 打开对应的文件，这需要把 demo 项目和 vue3 源码项目放到一个 workspace 下，再次调试就可以了。</p><p>vue3 源码的调试整体比 react 源码调试简单不少，因为不管是生成 sourcemap 还是把 sourcemap 加到项目里，vue 都做了不错的支持。</p></div><!----><!----><!----></div></main><footer class="vp-doc-footer" data-v-540f7185 data-v-e737c5a5><!--[--><!--]--><!----><div class="contributors" aria-label="Contributors" data-v-e737c5a5><span class="contributors-label" data-v-e737c5a5>贡献者: </span><span class="contributors-info" data-v-e737c5a5><!--[--><!--[--><span class="contributor" data-v-e737c5a5>hello-xiaowu</span><!----><!--]--><!--]--></span></div><nav class="prev-next" data-v-e737c5a5><div class="pager" data-v-e737c5a5><a class="vp-link no-icon link pager-link prev" href="/blog.github.io/article/dz2okvmh/" data-v-e737c5a5 data-v-a45fcd4d><!--[--><span class="desc" data-v-e737c5a5>上一页</span><span class="title" data-v-e737c5a5>调试 patch-package 源码</span><!--]--><!----></a></div><div class="pager" data-v-e737c5a5><!----></div></nav></footer><!----><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!--]--><button style="display:none;" type="button" class="vp-back-to-top" aria-label="back to top" data-v-f525dbff data-v-8910cbcb><span class="percent" data-allow-mismatch data-v-8910cbcb>0%</span><span class="show icon vpi-back-to-top" data-v-8910cbcb></span><svg aria-hidden="true" data-v-8910cbcb><circle cx="50%" cy="50%" data-allow-mismatch style="stroke-dasharray:calc(0% - 12.566370614359172px) calc(314.1592653589793% - 12.566370614359172px);" data-v-8910cbcb></circle></svg></button><footer class="vp-footer" vp-footer data-v-f525dbff data-v-35b9c334><!--[--><div class="container" data-v-35b9c334><p class="message" data-v-35b9c334>Powered by <a target="_blank" href="https://v2.vuepress.vuejs.org/">VuePress</a> & <a target="_blank" href="https://theme-plume.vuejs.press">vuepress-theme-plume</a></p><!----></div><!--]--></footer><!--[--><!--]--><!--]--></div><!----><!--]--><!--[--><!--]--><!--]--></div><script type="module" src="/blog.github.io/assets/app-DazCwyn3.js" defer></script></body></html>